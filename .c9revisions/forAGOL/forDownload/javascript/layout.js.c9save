{"ts":1353951824989,"silentsave":true,"restoring":false,"patch":[[{"diffs":[[1,"  dojo.provide(\"utilities.layout\");\r\n  dojo.require(\"esri.map\");\r\n  dojo.require(\"esri.layout\");\r\n  dojo.require(\"esri.widgets\");\r\n  dojo.require(\"esri.arcgis.utils\");\r\n  dojo.requireLocalization(\"esriTemplate\",\"template\");\r\n\r\n  //Jquery Layout\r\n    $(document).ready(function(e) {\r\n      $(\"#legendToggle\").click(function(){\r\n        if ($(\"#legendDiv\").css('display')=='none'){\r\n    \t  $(\"#legTogText\").html(i18n.viewer.legToggle.up);\r\n\t\t}\r\n\t\telse{\r\n\t\t  $(\"#legTogText\").html(i18n.viewer.legToggle.down);\r\n\t\t}\r\n\t\t$(\"#legendDiv\").slideToggle();\r\n\t  });\r\n    });\r\n\r\n  utilities.layout = {};\r\n  dojo.mixin(utilities.layout,{\r\n\r\n      map:null,\r\n      urlObject:null,\r\n      i18n:null,\r\n\r\n      initMap:function() {\r\n       utilities.layout.patchID();\r\n\r\n       //get the localization strings\r\n  \t   i18n = dojo.i18n.getLocalization(\"esriTemplate\",\"template\");\r\n\r\n\t   dojo.byId('loading').innerHTML = i18n.viewer.loading.message;\r\n\t   dojo.byId('legTogText').innerHTML = i18n.viewer.legToggle.down;\r\n\r\n       if(configOptions.geometryserviceurl && location.protocol === \"https:\"){\r\n         configOptions.geometryserviceurl = configOptions.geometryserviceurl.replace('http:','https:');\r\n       }\r\n       esri.config.defaults.geometryService = new esri.tasks.GeometryService(configOptions.geometryserviceurl);\r\n\r\n       if(!configOptions.sharingurl){\r\n         configOptions.sharingurl = location.protocol + '//' + location.host + \"/sharing/content/items\";\r\n       }\r\n       esri.arcgis.utils.arcgisUrl = configOptions.sharingurl;\r\n\r\n       if(!configOptions.proxyurl){\r\n         configOptions.proxyurl = location.protocol + '//' + location.host + \"/sharing/proxy\";\r\n       }\r\n\r\n       esri.config.defaults.io.proxyUrl =  configOptions.proxyurl;\r\n\r\n       esri.config.defaults.io.alwaysUseProxy = false;\r\n\r\n       urlObject = esri.urlToObject(document.location.href);\r\n       urlObject.query = urlObject.query || {};\r\n\r\n       if(urlObject.query.title){\r\n         configOptions.title = urlObject.query.title;\r\n       }\r\n       if(urlObject.query.subtitle){\r\n         configOptions.subtitle = urlObject.query.subtitle;\r\n       }\r\n\t   if(urlObject.query.legend){\r\n         configOptions.legend = urlObject.query.legend;\r\n       }\r\n       if(urlObject.query.webmap){\r\n         configOptions.webmap = urlObject.query.webmap;\r\n       }\r\n       if(urlObject.query.bingMapsKey){\r\n         configOptions.bingmapskey = urlObject.query.bingMapsKey;\r\n       }\r\n\r\n\t   \t   //is an appid specified - if so read json from there\r\n\t  if(configOptions.appid || (urlObject.query && urlObject.query.appid)){\r\n\t\tvar appid = configOptions.appid || urlObject.query.appid;\r\n\t\tvar requestHandle = esri.request({\r\n\t\t  url: configOptions.sharingurl + \"/\" + appid + \"/data\",\r\n\t\t  content: {f:\"json\"},\r\n\t\t  callbackParamName:\"callback\",\r\n\t\t  load: function(response){\r\n               if(response.values.webmap !== undefined){configOptions.webmap = response.values.webmap;}\r\n\t\t\t   if(response.values.title !== undefined){configOptions.title = response.values.title;}\r\n\t\t\t   if(response.values.subtitle !== undefined){configOptions.subtitle = response.values.subtitle;}\r\n\t\t\t   if(response.values.legend !== undefined){configOptions.legend = response.values.legend;}\r\n\r\n\t\t\t   utilities.layout.createMap();\r\n\t\t  },\r\n\t\t  error: function(response){\r\n\t\t\tvar e = response.message;\r\n\t\t   alert(i18n.viewer.errors.createMap +  response.message);\r\n\t\t  }\r\n\t\t});\r\n\t\t }else{\r\n\t\t\tutilities.layout.createMap();\r\n\t\t }\r\n\t },\r\n\r\n     createMap: function(){\r\n\r\n       if (configOptions.legend === \"false\" || configOptions.legend === false){\r\n           $(\"#legendCon\").hide();\r\n\t   }\r\n\r\n\t   var mapDeferred = esri.arcgis.utils.createMap(configOptions.webmap, \"map\", {\r\n         mapOptions: {\r\n           slider: true,\r\n           sliderStyle:\"small\",\r\n           nav: false,\r\n           wrapAround180:true\r\n         },\r\n         ignorePopups:false,\r\n         bingMapsKey: configOptions.bingmapskey\r\n       });\r\n\r\n       mapDeferred.addCallback(function (response) {\r\n\r\n\t\t document.title = configOptions.title|| response.itemInfo.item.title || \"\";\r\n         dojo.byId(\"title\").innerHTML = configOptions.title ||response.itemInfo.item.title || \"\";\r\n         dojo.byId(\"subtitle\").innerHTML = configOptions.subtitle|| response.itemInfo.item.snippet || \"\";\r\n\r\n         map = response.map;\r\n\r\n\t\t dojo.connect(map,\"onUpdateEnd\",utilities.layout.hideLoader);\r\n\r\n         var layers = response.itemInfo.itemData.operationalLayers;\r\n         if(map.loaded){\r\n           utilities.layout.initUI(layers);\r\n         }\r\n         else{\r\n           dojo.connect(map,\"onLoad\",function(){\r\n             utilities.layout.initUI(layers);\r\n           });\r\n         }\r\n         //resize the map when the browser resizes\r\n         dojo.connect(dijit.byId('map'), 'resize', map,map.resize);\r\n       });\r\n\r\n       mapDeferred.addErrback(function (error) {\r\n         alert(i18n.viewer.errors.createMap + dojo.toJson(error.message));\r\n       });\r\n\r\n     },\r\n\r\n     initUI: function(layers) {\r\n       //add chrome theme for popup\r\n       dojo.addClass(map.infoWindow.domNode, \"chrome\");\r\n       //add the scalebar\r\n       var scalebar = new esri.dijit.Scalebar({\r\n         map: map,\r\n         scalebarUnit:i18n.viewer.main.scaleBarUnits //metric or english\r\n       });\r\n\r\n       var layerInfo = utilities.layout.buildLayersList(layers);\r\n\r\n       if(layerInfo.length > 0){\r\n         var legendDijit = new esri.dijit.Legend({\r\n           map:map,\r\n           layerInfos:layerInfo\r\n         },\"legendDiv\");\r\n         legendDijit.startup();\r\n       }\r\n       else{\r\n         $(\"#legendToggle\").hide();\r\n       }\r\n     },\r\n\r\n     //build a list of layers to dispaly in the legend\r\n  buildLayersList: function(layers){\r\n\r\n //layers  arg is  response.itemInfo.itemData.operationalLayers;\r\n  var layerInfos = [];\r\n  dojo.forEach(layers, function (mapLayer, index) {\r\n      var layerInfo = {};\r\n      if (mapLayer.featureCollection && mapLayer.type !== \"CSV\") {\r\n        if (mapLayer.featureCollection.showLegend === true) {\r\n            dojo.forEach(mapLayer.featureCollection.layers, function (fcMapLayer) {\r\n              if (fcMapLayer.showLegend !== false) {\r\n                  layerInfo = {\r\n                      \"layer\": fcMapLayer.layerObject,\r\n                      \"title\": mapLayer.title,\r\n                      \"defaultSymbol\": false\r\n                  };\r\n                  if (mapLayer.featureCollection.layers.length > 1) {\r\n                      layerInfo.title += \" - \" + fcMapLayer.layerDefinition.name;\r\n                  }\r\n                  layerInfos.push(layerInfo);\r\n              }\r\n            });\r\n          }\r\n      } else if (mapLayer.showLegend !== false && mapLayer.layerObject) {\r\n      var showDefaultSymbol = false;\r\n      if (mapLayer.layerObject.version < 10.1 && (mapLayer.layerObject instanceof esri.layers.ArcGISDynamicMapServiceLayer || mapLayer.layerObject instanceof esri.layers.ArcGISTiledMapServiceLayer)) {\r\n        showDefaultSymbol = true;\r\n      }\r\n      layerInfo = {\r\n        \"layer\": mapLayer.layerObject,\r\n        \"title\": mapLayer.title,\r\n        \"defaultSymbol\": showDefaultSymbol\r\n      };\r\n        //does it have layers too? If so check to see if showLegend is false\r\n        if (mapLayer.layers) {\r\n            var hideLayers = dojo.map(dojo.filter(mapLayer.layers, function (lyr) {\r\n                return (lyr.showLegend === false);\r\n            }), function (lyr) {\r\n                return lyr.id;\r\n            });\r\n            if (hideLayers.length) {\r\n                layerInfo.hideLayers = hideLayers;\r\n            }\r\n        }\r\n        layerInfos.push(layerInfo);\r\n    }\r\n  });\r\n  return layerInfos;\r\n  },\r\n\r\n  patchID: function() {  //patch id manager for use in apps.arcgis.com\r\n       esri.id._isIdProvider = function(server, resource) {\r\n       // server and resource are assumed one of portal domains\r\n\r\n       var i = -1, j = -1;\r\n\r\n       dojo.forEach(this._gwDomains, function(domain, idx) {\r\n         if (i === -1 && domain.regex.test(server)) {\r\n           i = idx;\r\n         }\r\n         if (j === -1 && domain.regex.test(resource)) {\r\n           j = idx;\r\n         }\r\n       });\r\n\r\n       var retVal = false;\r\n\r\n       if (i > -1 && j > -1) {\r\n         if (i === 0 || i === 4) {\r\n           if (j === 0 || j === 4) {\r\n             retVal = true;\r\n           }\r\n         }\r\n         else if (i === 1) {\r\n           if (j === 1 || j === 2) {\r\n             retVal = true;\r\n           }\r\n         }\r\n         else if (i === 2) {\r\n           if (j === 2) {\r\n             retVal = true;\r\n           }\r\n         }\r\n         else if (i === 3) {\r\n           if (j === 3) {\r\n             retVal = true;\r\n           }\r\n         }\r\n       }\r\n\r\n       return retVal;\r\n     };\r\n    },\r\n\r\n    hideLoader:function(){\r\n      $(\"#loadingCon\").hide();\r\n\t}\r\n\r\n\r\n  });"]],"start1":0,"start2":0,"length1":0,"length2":8836}]],"length":8836}
{"contributors":[],"silentsave":true,"ts":1353952578627,"patch":[[{"diffs":[[-1,"  dojo.provide(\"utilities.layout\");\r\n"],[0,"  dojo."],[1,""],[0,"requ"]],"start1":0,"start2":0,"length1":48,"length2":11},{"diffs":[[0,"\r\n\r\n"],[-1,"  //Jquery Layout\r\n    $(document).ready(function(e"],[1,"\r\n     var map, urlObject, i18n;\r\n\r\n     function initMap("],[0,") {\r"]],"start1":186,"start2":186,"length1":59,"length2":66},{"diffs":[[0,"    "],[-1,"$(\"#legendToggle\").click("],[1," patchID();\r\n       \r\n       dojo.some([\"ar\",\"he\"], "],[0,"func"]],"start1":255,"start2":255,"length1":33,"length2":60},{"diffs":[[0,"\"he\"], function("],[1,"l"],[0,"){\r\n        if ("]],"start1":304,"start2":304,"length1":32,"length2":33},{"diffs":[[0,"    "],[1," "],[0,"if"],[-1," ($(\"#legendDiv\").css('display')=='none'"],[1,"(dojo.locale.indexOf(l) !== -1"],[0,"){\r\n    "],[-1,"\t"],[0,"  "],[-1,"$(\"#legTogText\").html(i18n.viewer.legToggle.up);\r\n\t\t}\r\n\t\telse{\r\n\t\t  $(\"#legTogText\").html(i18n.viewer.legToggle.down);\r\n\t\t}\r\n\t\t$(\"#legendDiv\").slideToggle()"],[1,"     configOptions.isRightToLeft = true;\r\n           return true;\r\n         }\r\n       });\r\n       var dirNode = document.getElementsByTagName(\"html\")[0]"],[0,";\r\n"],[-1,"\t"],[0,"  "],[-1,"});\r\n    });\r\n\r\n  utilities.layout = {};\r\n  dojo.mixin(utilities.layout,{\r\n\r\n      map:null,\r\n      urlObject:null,\r\n      i18n:null,\r\n\r\n      initMap:function() {\r\n       utilities.layout.patchID("],[1,"     if(configOptions.isRightToLeft){\r\n         dirNode.setAttribute(\"dir\",\"rtl\");\r\n         dojo.addClass( dirNode,\"esriRtl\");\r\n       }else{\r\n         dirNode.setAttribute(\"dir\",\"ltr\");\r\n         dojo.addClass(dirNode,\"esriLtr\""],[0,");\r\n"],[-1,"\r\n"],[1,"   "],[0,"    "],[1,"}\r\n\r\n\t"],[0,"   /"]],"start1":329,"start2":329,"length1":430,"length2":454},{"diffs":[[0,"\r\n\t\t\t   "],[-1,"utilities.layout."],[1,""],[0,"createMa"]],"start1":3255,"start2":3255,"length1":33,"length2":16},{"diffs":[[0,"se{\r\n\t\t\t"],[-1,"utilities.layout."],[0,"createMa"]],"start1":3430,"start2":3430,"length1":33,"length2":16},{"diffs":[[0,"\n\t }"],[-1,","],[0,"\r\n\r\n"],[-1,"     createMap: function"],[1,"\t function createMap"],[0,"(){\r\n\r\n"],[-1,"    "],[1,"\t"],[0,"   i"]],"start1":3457,"start2":3457,"length1":48,"length2":40},{"diffs":[[0,"ateEnd\","],[-1,"utilities.layout."],[1,""],[0,"hideLoad"]],"start1":4342,"start2":4342,"length1":33,"length2":16},{"diffs":[[0,"        "],[-1,"utilities.layout."],[1,""],[0,"initUI(l"]],"start1":4464,"start2":4464,"length1":33,"length2":16},{"diffs":[[0,"        "],[-1,"utilities.layout."],[1,""],[0,"initUI(l"]],"start1":4572,"start2":4572,"length1":33,"length2":16},{"diffs":[[0,"   }"],[-1,","],[1,"\r\n"],[0,"\r\n\r\n    "],[-1," initUI:"],[0," fun"]],"start1":4902,"start2":4902,"length1":25,"length2":18},{"diffs":[[0,"\n\r\n     function"],[1," initUI"],[0,"(layers) {\r\n    "]],"start1":4909,"start2":4909,"length1":32,"length2":39},{"diffs":[[0,"o = "],[-1,"utilities.layout."],[1,""],[0,"buil"]],"start1":5241,"start2":5241,"length1":25,"length2":8},{"diffs":[[0,"   }"],[-1,","],[0,"\r\n\r\n"],[-1,"     "],[0,"//bu"]],"start1":5545,"start2":5545,"length1":18,"length2":12},{"diffs":[[0,"gend\r\n  "],[1,"function "],[0,"buildLay"]],"start1":5598,"start2":5598,"length1":16,"length2":25},{"diffs":[[0,"yersList"],[-1,": function"],[0,"(layers)"]],"start1":5622,"start2":5622,"length1":26,"length2":16},{"diffs":[[0,"\n  }"],[-1,","],[1,"\r\n"],[0,"\r\n\r\n  "],[-1,"patchID:"],[1,"  "],[0," fun"]],"start1":7583,"start2":7583,"length1":23,"length2":18},{"diffs":[[0,"function"],[1," patchID"],[0,"() {  //"]],"start1":7598,"start2":7598,"length1":16,"length2":24},{"diffs":[[0,"   }"],[-1,","],[0,"\r\n\r\n"],[-1,"    hideLoader:"],[1,"\tfunction hideLoader(){\r\n\t  $(\"#loadingCon\").hide();\r\n\t}\r\n\r\n\t//Jquery Layout\r\n\t$(document).ready("],[0,"func"]],"start1":8662,"start2":8662,"length1":28,"length2":109},{"diffs":[[0,"ion("],[-1,")"],[1,"e) "],[0,"{\r\n"],[1,"\t"],[0,"  "],[-1,"    $(\"#loadingCon\").hide("],[1,"$(\"#legendToggle\").click(function(){\r\n\t\tif ($(\"#legendDiv\").css('display')=='none'){\r\n\t\t  $(\"#legTogText\").html(i18n.viewer.legToggle.up);\r\n\t\t}\r\n\t\telse{\r\n\t\t  $(\"#legTogText\").html(i18n.viewer.legToggle.down"],[0,");\r\n"],[1,"\t"],[0,"\t}\r\n"],[-1,"\r\n\r\n"],[1,"\t\t$(\"#legendDiv\").slideToggle();\r\n\t  });\r\n  "],[0,"  })"]],"start1":8772,"start2":8772,"length1":52,"length2":276}]],"length":9049,"saved":false}
{"ts":1353952578898,"patch":[[{"diffs":[[0,"hID();\r\n"],[-1,"       "],[0,"\r\n      "]],"start1":264,"start2":264,"length1":23,"length2":16}]],"length":9042,"saved":false}
{"ts":1353953815700,"patch":[[{"diffs":[[0,"esriRtl\");\r\n"],[1,"         //Page Specific\r\n         dojo.attr(dojo.byId(\"legendCon\"),\"dir\",\"rtl\");\r\n"],[0,"       }else"]],"start1":643,"start2":643,"length1":24,"length2":107},{"diffs":[[0,"    }else{\r\n"],[-1,""],[0,"         dir"]],"start1":741,"start2":741,"length1":24,"length2":24},{"diffs":[[0,"esriLtr\");\r\n"],[1,"         //Page Specific\r\n         dojo.attr(dojo.byId(\"legendCon\"),\"dir\",\"ltr\");\r\n"],[0,"       }\r\n\r\n"]],"start1":830,"start2":830,"length1":24,"length2":107},{"diffs":[[0,"  configOptions."],[-1,"sub"],[0,"title = urlObjec"]],"start1":2243,"start2":2243,"length1":35,"length2":32},{"diffs":[[0," }\r\n"],[-1,"\t   if(urlObject.query.legend){\r\n         configOptions.legend = urlObject.query.legend;\r\n       }\r\n"],[0,"    "]],"start1":2300,"start2":2300,"length1":108,"length2":8},{"diffs":[[0,"map;\r\n       }\r\n"],[1,"       if(urlObject.query.legend){\r\n         configOptions.legend = urlObject.query.legend;\r\n       }\r\n"],[0,"       if(urlObj"]],"start1":2391,"start2":2391,"length1":32,"length2":135},{"diffs":[[0,"\r\n\r\n"],[-1,"\t"],[0,"   "],[-1,"\t"],[0,"   "],[-1,"//is an appid specified - if so read json from there\r\n\t  if(configOptions.appid || (urlObject.query && urlObject.query.appid)){\r\n\t\tvar appid = configOptions.appid || urlObject.query.appid;\r\n\t\tvar requestHandle = esri.request({\r\n\t\t  url: configOptions.sharingurl + \"/\" + appid + \"/data\",\r\n\t\t  content: {f:\"json\"},\r\n\t\t  callbackParamName:\"callback\",\r\n\t\t  load: function(response){\r\n               if(response.values.webmap !== undefined){configOptions.webmap = response.values.webmap;}\r\n\t\t\t   if(response.values.title !== undefined){configOptions.title = response.values.title;}\r\n\t\t\t   if(response.values.subtitle !== undefined){configOptions.subtitle = response.values.subtitle;}\r\n\t\t\t   if(response.values.legend !== undefined){configOptions.legend = response.values.legend;}\r\n\r\n\t\t\t   createMap();\r\n\t\t  },\r\n\t\t  error: function(response){\r\n\t\t\tvar e = response.message;\r\n\t\t   alert(i18n.viewer.errors.createMap +  response.message);\r\n\t\t  }\r\n\t\t});\r\n\t\t }else{\r\n\t\t\tcreateMap();\r\n\t\t }\r\n\t }\r\n\r\n\t function createMap(){\r\n\r\n\t  "],[0," if "]],"start1":2626,"start2":2626,"length1":1032,"length2":14},{"diffs":[[0,"){\r\n    "],[-1,"    "],[1,"\t"],[0,"   $(\"#l"]],"start1":2707,"start2":2707,"length1":20,"length2":17},{"diffs":[[0,"nglish\r\n"],[-1,""],[0,"       }"]],"start1":4338,"start2":4338,"length1":16,"length2":16},{"diffs":[[0,"\r\n       });\r\n\r\n"],[1,"\r\n"],[0,"       var layer"]],"start1":4344,"start2":4344,"length1":32,"length2":34}]],"length":8189,"saved":false}
{"ts":1353953876611,"patch":[[{"diffs":[[0,"rlObject"],[1,"s"],[0,", i18n;\r"]],"start1":207,"start2":207,"length1":16,"length2":17}]],"length":8190,"saved":false}
{"ts":1353954231375,"patch":[[{"diffs":[[0,"se){"],[-1,"\r\n    \t   $(\"#legendCon\").hide();"],[1,"https://c9.io/ssylvia_storymaps/storytellingtemplate_dropdownlegend/workspace/forAGOL/forDownload/index.html"],[0,"\r\n\t "]],"start1":2706,"start2":2706,"length1":41,"length2":116}]],"length":8265,"saved":false}
{"ts":1353954232991,"patch":[[{"diffs":[[0,"se){"],[-1,"https://c9.io/ssylvia_storymaps/storytellingtemplate_dropdownlegend/workspace/forAGOL/forDownload/index.html"],[1,"\r\n    \t   $(\"#legendCon\").hide();"],[0,"\r\n\t "]],"start1":2706,"start2":2706,"length1":116,"length2":41}]],"length":8190,"saved":false}
{"ts":1353954276330,"patch":[[{"diffs":[[0,"        "],[1,"\r\n           "],[0,"$(\"#lege"]],"start1":4638,"start2":4638,"length1":16,"length2":29},{"diffs":[[0,"\"#legend"],[-1,"Toggle"],[1,"Con"],[0,"\").hide("]],"start1":4661,"start2":4661,"length1":22,"length2":19}]],"length":8200,"saved":false}
{"ts":1353954280171,"patch":[[{"diffs":[[0," }\r\n       else{"],[-1,"\r\n"],[0,"         \r\n     "]],"start1":4619,"start2":4619,"length1":34,"length2":32}]],"length":8198,"saved":false}
