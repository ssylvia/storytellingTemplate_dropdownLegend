{"ts":1353954266230,"silentsave":true,"restoring":false,"patch":[[{"diffs":[[1,"  dojo.require(\"esri.map\");\r\n  dojo.require(\"esri.layout\");\r\n  dojo.require(\"esri.widgets\");\r\n  dojo.require(\"esri.arcgis.utils\");\r\n  dojo.requireLocalization(\"esriTemplate\",\"template\");\r\n\r\n\r\n     var map, urlObject, i18n;\r\n\r\n     function initMap() {\r\n       patchID();\r\n\r\n       dojo.some([\"ar\",\"he\"], function(l){\r\n         if(dojo.locale.indexOf(l) !== -1){\r\n           configOptions.isRightToLeft = true;\r\n           return true;\r\n         }\r\n       });\r\n       var dirNode = document.getElementsByTagName(\"html\")[0];\r\n       if(configOptions.isRightToLeft){\r\n         dirNode.setAttribute(\"dir\",\"rtl\");\r\n         dojo.addClass( dirNode,\"esriRtl\");\r\n       }else{\r\n         dirNode.setAttribute(\"dir\",\"ltr\");\r\n         dojo.addClass(dirNode,\"esriLtr\");\r\n       }\r\n\r\n       //get the localization strings\r\n  \t   i18n = dojo.i18n.getLocalization(\"esriTemplate\",\"template\");\r\n\r\n\t   dojo.byId('loading').innerHTML = i18n.viewer.loading.message;\r\n\t   dojo.byId('legTogText').innerHTML = i18n.viewer.legToggle.down;\r\n\r\n       if(configOptions.geometryserviceurl && location.protocol === \"https:\"){\r\n         configOptions.geometryserviceurl = configOptions.geometryserviceurl.replace('http:','https:');\r\n       }\r\n       esri.config.defaults.geometryService = new esri.tasks.GeometryService(configOptions.geometryserviceurl);\r\n\r\n       if(!configOptions.sharingurl){\r\n         configOptions.sharingurl = location.protocol + '//' + location.host + \"/sharing/content/items\";\r\n       }\r\n       esri.arcgis.utils.arcgisUrl = configOptions.sharingurl;\r\n\r\n       if(!configOptions.proxyurl){\r\n         configOptions.proxyurl = location.protocol + '//' + location.host + \"/sharing/proxy\";\r\n       }\r\n\r\n       esri.config.defaults.io.proxyUrl =  configOptions.proxyurl;\r\n\r\n       esri.config.defaults.io.alwaysUseProxy = false;\r\n\r\n       urlObject = esri.urlToObject(document.location.href);\r\n       urlObject.query = urlObject.query || {};\r\n\r\n       if(urlObject.query.title){\r\n         configOptions.title = urlObject.query.title;\r\n       }\r\n       if(urlObject.query.subtitle){\r\n         configOptions.subtitle = urlObject.query.subtitle;\r\n       }\r\n\t   if(urlObject.query.legend){\r\n         configOptions.legend = urlObject.query.legend;\r\n       }\r\n       if(urlObject.query.webmap){\r\n         configOptions.webmap = urlObject.query.webmap;\r\n       }\r\n       if(urlObject.query.bingMapsKey){\r\n         configOptions.bingmapskey = urlObject.query.bingMapsKey;\r\n       }\r\n\r\n\t   \t   //is an appid specified - if so read json from there\r\n\t  if(configOptions.appid || (urlObject.query && urlObject.query.appid)){\r\n\t\tvar appid = configOptions.appid || urlObject.query.appid;\r\n\t\tvar requestHandle = esri.request({\r\n\t\t  url: configOptions.sharingurl + \"/\" + appid + \"/data\",\r\n\t\t  content: {f:\"json\"},\r\n\t\t  callbackParamName:\"callback\",\r\n\t\t  load: function(response){\r\n               if(response.values.webmap !== undefined){configOptions.webmap = response.values.webmap;}\r\n\t\t\t   if(response.values.title !== undefined){configOptions.title = response.values.title;}\r\n\t\t\t   if(response.values.subtitle !== undefined){configOptions.subtitle = response.values.subtitle;}\r\n\t\t\t   if(response.values.legend !== undefined){configOptions.legend = response.values.legend;}\r\n\r\n\t\t\t   createMap();\r\n\t\t  },\r\n\t\t  error: function(response){\r\n\t\t\tvar e = response.message;\r\n\t\t   alert(i18n.viewer.errors.createMap +  response.message);\r\n\t\t  }\r\n\t\t});\r\n\t\t }else{\r\n\t\t\tcreateMap();\r\n\t\t }\r\n\t }\r\n\r\n\t function createMap(){\r\n\r\n\t   if (configOptions.legend === \"false\" || configOptions.legend === false){\r\n           $(\"#legendCon\").hide();\r\n\t   }\r\n\r\n\t   var mapDeferred = esri.arcgis.utils.createMap(configOptions.webmap, \"map\", {\r\n         mapOptions: {\r\n           slider: true,\r\n           sliderStyle:\"small\",\r\n           nav: false,\r\n           wrapAround180:true\r\n         },\r\n         ignorePopups:false,\r\n         bingMapsKey: configOptions.bingmapskey\r\n       });\r\n\r\n       mapDeferred.addCallback(function (response) {\r\n\r\n\t\t document.title = configOptions.title|| response.itemInfo.item.title || \"\";\r\n         dojo.byId(\"title\").innerHTML = configOptions.title ||response.itemInfo.item.title || \"\";\r\n         dojo.byId(\"subtitle\").innerHTML = configOptions.subtitle|| response.itemInfo.item.snippet || \"\";\r\n\r\n         map = response.map;\r\n\r\n\t\t dojo.connect(map,\"onUpdateEnd\",hideLoader);\r\n\r\n         var layers = response.itemInfo.itemData.operationalLayers;\r\n         if(map.loaded){\r\n           initUI(layers);\r\n         }\r\n         else{\r\n           dojo.connect(map,\"onLoad\",function(){\r\n             initUI(layers);\r\n           });\r\n         }\r\n         //resize the map when the browser resizes\r\n         dojo.connect(dijit.byId('map'), 'resize', map,map.resize);\r\n       });\r\n\r\n       mapDeferred.addErrback(function (error) {\r\n         alert(i18n.viewer.errors.createMap + dojo.toJson(error.message));\r\n       });\r\n\r\n     }\r\n\r\n\r\n     function initUI(layers) {\r\n       //add chrome theme for popup\r\n       dojo.addClass(map.infoWindow.domNode, \"chrome\");\r\n       //add the scalebar\r\n       var scalebar = new esri.dijit.Scalebar({\r\n         map: map,\r\n         scalebarUnit:i18n.viewer.main.scaleBarUnits //metric or english\r\n       });\r\n\r\n       var layerInfo = buildLayersList(layers);\r\n\r\n       if(layerInfo.length > 0){\r\n         var legendDijit = new esri.dijit.Legend({\r\n           map:map,\r\n           layerInfos:layerInfo\r\n         },\"legendDiv\");\r\n         legendDijit.startup();\r\n       }\r\n       else{\r\n         $(\"#legendToggle\").hide();\r\n       }\r\n     }\r\n\r\n//build a list of layers to dispaly in the legend\r\n  function buildLayersList(layers){\r\n\r\n //layers  arg is  response.itemInfo.itemData.operationalLayers;\r\n  var layerInfos = [];\r\n  dojo.forEach(layers, function (mapLayer, index) {\r\n      var layerInfo = {};\r\n      if (mapLayer.featureCollection && mapLayer.type !== \"CSV\") {\r\n        if (mapLayer.featureCollection.showLegend === true) {\r\n            dojo.forEach(mapLayer.featureCollection.layers, function (fcMapLayer) {\r\n              if (fcMapLayer.showLegend !== false) {\r\n                  layerInfo = {\r\n                      \"layer\": fcMapLayer.layerObject,\r\n                      \"title\": mapLayer.title,\r\n                      \"defaultSymbol\": false\r\n                  };\r\n                  if (mapLayer.featureCollection.layers.length > 1) {\r\n                      layerInfo.title += \" - \" + fcMapLayer.layerDefinition.name;\r\n                  }\r\n                  layerInfos.push(layerInfo);\r\n              }\r\n            });\r\n          }\r\n      } else if (mapLayer.showLegend !== false && mapLayer.layerObject) {\r\n      var showDefaultSymbol = false;\r\n      if (mapLayer.layerObject.version < 10.1 && (mapLayer.layerObject instanceof esri.layers.ArcGISDynamicMapServiceLayer || mapLayer.layerObject instanceof esri.layers.ArcGISTiledMapServiceLayer)) {\r\n        showDefaultSymbol = true;\r\n      }\r\n      layerInfo = {\r\n        \"layer\": mapLayer.layerObject,\r\n        \"title\": mapLayer.title,\r\n        \"defaultSymbol\": showDefaultSymbol\r\n      };\r\n        //does it have layers too? If so check to see if showLegend is false\r\n        if (mapLayer.layers) {\r\n            var hideLayers = dojo.map(dojo.filter(mapLayer.layers, function (lyr) {\r\n                return (lyr.showLegend === false);\r\n            }), function (lyr) {\r\n                return lyr.id;\r\n            });\r\n            if (hideLayers.length) {\r\n                layerInfo.hideLayers = hideLayers;\r\n            }\r\n        }\r\n        layerInfos.push(layerInfo);\r\n    }\r\n  });\r\n  return layerInfos;\r\n  }\r\n\r\n\r\n     function patchID() {  //patch id manager for use in apps.arcgis.com\r\n       esri.id._isIdProvider = function(server, resource) {\r\n       // server and resource are assumed one of portal domains\r\n\r\n       var i = -1, j = -1;\r\n\r\n       dojo.forEach(this._gwDomains, function(domain, idx) {\r\n         if (i === -1 && domain.regex.test(server)) {\r\n           i = idx;\r\n         }\r\n         if (j === -1 && domain.regex.test(resource)) {\r\n           j = idx;\r\n         }\r\n       });\r\n\r\n       var retVal = false;\r\n\r\n       if (i > -1 && j > -1) {\r\n         if (i === 0 || i === 4) {\r\n           if (j === 0 || j === 4) {\r\n             retVal = true;\r\n           }\r\n         }\r\n         else if (i === 1) {\r\n           if (j === 1 || j === 2) {\r\n             retVal = true;\r\n           }\r\n         }\r\n         else if (i === 2) {\r\n           if (j === 2) {\r\n             retVal = true;\r\n           }\r\n         }\r\n         else if (i === 3) {\r\n           if (j === 3) {\r\n             retVal = true;\r\n           }\r\n         }\r\n       }\r\n\r\n       return retVal;\r\n     };\r\n    }\r\n\r\n\tfunction hideLoader(){\r\n\t  $(\"#loadingCon\").hide();\r\n\t}\r\n\r\n\t//Jquery Layout\r\n\t$(document).ready(function(e) {\r\n\t  $(\"#legendToggle\").click(function(){\r\n\t\tif ($(\"#legendDiv\").css('display')=='none'){\r\n\t\t  $(\"#legTogText\").html(i18n.viewer.legToggle.up);\r\n\t\t}\r\n\t\telse{\r\n\t\t  $(\"#legTogText\").html(i18n.viewer.legToggle.down);\r\n\t\t}\r\n\t\t$(\"#legendDiv\").slideToggle();\r\n\t  });\r\n    });"]],"start1":0,"start2":0,"length1":0,"length2":9045}]],"length":9045}
{"contributors":[],"silentsave":false,"ts":1353954334230,"patch":[[{"diffs":[[0,"rlObject"],[1,"s"],[0,", i18n;\r"]],"start1":207,"start2":207,"length1":16,"length2":17},{"diffs":[[0,"cts, i18n;\r\n"],[-1,""],[0,"\r\n     funct"]],"start1":213,"start2":213,"length1":24,"length2":24},{"diffs":[[0,"esriRtl\");\r\n"],[1,"         //Page Specific\r\n         dojo.attr(dojo.byId(\"legendCon\"),\"dir\",\"rtl\");\r\n"],[0,"       }else"]],"start1":644,"start2":644,"length1":24,"length2":107},{"diffs":[[0,"esriLtr\");\r\n"],[1,"         //Page Specific\r\n         dojo.attr(dojo.byId(\"legendCon\"),\"dir\",\"ltr\");\r\n"],[0,"       }\r\n\r\n"]],"start1":831,"start2":831,"length1":24,"length2":107},{"diffs":[[0,"  configOptions."],[-1,"sub"],[0,"title = urlObjec"]],"start1":2247,"start2":2247,"length1":35,"length2":32},{"diffs":[[0," }\r\n"],[-1,"\t   if(urlObject.query.legend){\r\n         configOptions.legend = urlObject.query.legend;\r\n       }\r\n"],[0,"    "]],"start1":2304,"start2":2304,"length1":108,"length2":8},{"diffs":[[0,"map;\r\n       }\r\n"],[1,"       if(urlObject.query.legend){\r\n         configOptions.legend = urlObject.query.legend;\r\n       }\r\n"],[0,"       if(urlObj"]],"start1":2395,"start2":2395,"length1":32,"length2":135},{"diffs":[[0,"\r\n\r\n"],[-1,"\t"],[0,"   "],[-1,"\t"],[0,"   "],[-1,"//is an appid specified - if so read json from there\r\n\t  if(configOptions.appid || (urlObject.query && urlObject.query.appid)){\r\n\t\tvar appid = configOptions.appid || urlObject.query.appid;\r\n\t\tvar requestHandle = esri.request({\r\n\t\t  url: configOptions.sharingurl + \"/\" + appid + \"/data\",\r\n\t\t  content: {f:\"json\"},\r\n\t\t  callbackParamName:\"callback\",\r\n\t\t  load: function(response){\r\n               if(response.values.webmap !== undefined){configOptions.webmap = response.values.webmap;}\r\n\t\t\t   if(response.values.title !== undefined){configOptions.title = response.values.title;}\r\n\t\t\t   if(response.values.subtitle !== undefined){configOptions.subtitle = response.values.subtitle;}\r\n\t\t\t   if(response.values.legend !== undefined){configOptions.legend = response.values.legend;}\r\n\r\n\t\t\t   createMap();\r\n\t\t  },\r\n\t\t  error: function(response){\r\n\t\t\tvar e = response.message;\r\n\t\t   alert(i18n.viewer.errors.createMap +  response.message);\r\n\t\t  }\r\n\t\t});\r\n\t\t }else{\r\n\t\t\tcreateMap();\r\n\t\t }\r\n\t }\r\n\r\n\t function createMap(){\r\n\r\n\t  "],[0," if "]],"start1":2630,"start2":2630,"length1":1032,"length2":14},{"diffs":[[0,"){\r\n    "],[-1,"    "],[1,"\t"],[0,"   $(\"#l"]],"start1":2711,"start2":2711,"length1":20,"length2":17},{"diffs":[[0,"\r\n       });\r\n\r\n"],[1,"\r\n"],[0,"       var layer"]],"start1":4348,"start2":4348,"length1":32,"length2":34},{"diffs":[[0," }\r\n       else{"],[-1,"\r\n"],[1,"         \r\n  "],[0,"         $(\"#leg"]],"start1":4622,"start2":4622,"length1":34,"length2":45},{"diffs":[[0,"\"#legend"],[-1,"Toggle"],[1,"Con"],[0,"\").hide("]],"start1":4662,"start2":4662,"length1":22,"length2":19}]],"length":8201,"saved":false}
{"contributors":[],"silentsave":true,"ts":1354891571687,"patch":[[{"diffs":[[0,"sKey;\r\n       }\r"],[1,"\n       \r\n       \r"],[0,"\n\r\n       if (co"]],"start1":2615,"start2":2615,"length1":32,"length2":50}]],"length":8219,"saved":false}
{"ts":1354891572936,"patch":[[{"diffs":[[0," \r\n     "],[-1,"  "],[1,"}"],[0,"\r\n\r\n    "]],"start1":2638,"start2":2638,"length1":18,"length2":17}]],"length":8218,"saved":false}
{"ts":1354891575165,"patch":[[{"diffs":[[0,"   \r\n     }\r"],[1,"\n     \r\n     v\r"],[0,"\n\r\n       if"]],"start1":2636,"start2":2636,"length1":24,"length2":39}]],"length":8233,"saved":false}
{"ts":1354891576392,"patch":[[{"diffs":[[0,"\r\n     v"],[1,"ar"],[0,"\r\n\r\n    "]],"start1":2654,"start2":2654,"length1":16,"length2":18}]],"length":8235,"saved":false}
{"ts":1354891578208,"patch":[[{"diffs":[[0,"     var"],[1," createMap"],[0,"\r\n\r\n    "]],"start1":2656,"start2":2656,"length1":16,"length2":26}]],"length":8245,"saved":false}
{"ts":1354891582138,"patch":[[{"diffs":[[0,"reateMap"],[1," = function"],[0,"\r\n\r\n    "]],"start1":2666,"start2":2666,"length1":16,"length2":27}]],"length":8256,"saved":false}
{"ts":1354891582946,"patch":[[{"diffs":[[0,"function"],[1,"()"],[0,"\r\n\r\n    "]],"start1":2677,"start2":2677,"length1":16,"length2":18}]],"length":8258,"saved":false}
{"ts":1354891585002,"patch":[[{"diffs":[[0,"nction()"],[1,"{"],[0,"\r\n\r\n    "]],"start1":2679,"start2":2679,"length1":16,"length2":17}]],"length":8259,"saved":false}
{"ts":1354891597064,"patch":[[{"diffs":[[0,"  }\r"],[-1,"\n       \r\n     }\r\n     \r\n     var createMap = function(){\r"],[0,"\n\r\n "]],"start1":2627,"start2":2627,"length1":66,"length2":8}]],"length":8201,"saved":false}
{"ts":1354891597689,"patch":[[{"diffs":[[0,"   else{"],[-1,"         "],[0,"\r\n      "]],"start1":4630,"start2":4630,"length1":25,"length2":16}]],"length":8192,"saved":false}
